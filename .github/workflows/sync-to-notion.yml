name: Sync to Notion

on:
  push:
    branches: [main]
    paths:
      - 'knowledge-base/**'
      - 'agents/**'
      - 'outputs/**'
      - 'CLAUDE.md'
      - 'README.md'
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'Force sync all files'
        required: false
        default: 'false'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to detect changes

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: scripts/notion-sync/package-lock.json

      - name: Install dependencies
        working-directory: scripts/notion-sync
        run: npm ci

      - name: Run tests
        working-directory: scripts/notion-sync
        run: npm test

      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event.inputs.force_sync }}" == "true" ]; then
            echo "files=$(find knowledge-base agents outputs -name '*.md' 2>/dev/null | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
            echo "force=true" >> $GITHUB_OUTPUT
          else
            echo "files=$(git diff --name-only HEAD~1 HEAD -- '*.md' | tr '\n' ',' | sed 's/,$//')" >> $GITHUB_OUTPUT
            echo "force=false" >> $GITHUB_OUTPUT
          fi

      - name: Sync to Notion
        working-directory: scripts/notion-sync
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_KNOWLEDGE_BASE_DB: ${{ secrets.NOTION_KNOWLEDGE_BASE_DB }}
          NOTION_AGENT_ACTIVITY_DB: ${{ secrets.NOTION_AGENT_ACTIVITY_DB }}
          NOTION_REVIEW_QUEUE_DB: ${{ secrets.NOTION_REVIEW_QUEUE_DB }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
        run: |
          if [ "${{ steps.changed-files.outputs.force }}" == "true" ]; then
            npm run sync:to-notion -- --force
          elif [ -n "${{ steps.changed-files.outputs.files }}" ]; then
            npm run sync:to-notion -- --files "${{ steps.changed-files.outputs.files }}"
          else
            echo "No markdown files changed"
          fi

      - name: Update sync state
        if: success()
        run: |
          if [ -f scripts/notion-sync/.sync-state.json ]; then
            git config user.name "GitHub Actions Bot"
            git config user.email "actions@github.com"
            git add scripts/notion-sync/.sync-state.json
            git diff --quiet --staged || git commit -m "Update sync state [skip ci]"
            git push || true
          fi
